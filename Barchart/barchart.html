<!DOCTYPE html>

<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>graph</title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<link rel="stylesheet" href="barchart.css">
	<link rel="stylesheet" href="../Concordance/concordance.css">
</head>

<body>
	
	<form>
		Query : <input id="text_query" type="text" name="text_query" placeholder="enter the word"><br>
		Descending : <input id="dsc_order" type="radio" name="sorting_order" value="descending" onchange="order_changed()" checked><br>
		Ascending : <input id="asc_order" type="radio" name="sorting_order" value="ascending" onchange="order_changed()"><br>
		Bar count : <input id="bar_count" type="number" name="bar_count" onchange="barcount_changed()">
	</form>
	
	<svg id="svg_barchart"></svg>
	
	<script src="./barchart.js" type="text/javascript"></script>
	<script src="../Concordance/concordance.js" type="text/javascript"></script>
	<script type="text/javascript">
	
	var text_query = document.getElementById('text_query');
	text_query.onkeyup = function()
	{
	
		selected_data = new Array();
		
		for (var key in barchart_data)
		{
			var temp = barchart_data[key].word;
			
			// current word contains the query
			if (temp.includes(text_query.value) || temp == text_query.value)
			{
				selected_data.push(barchart_data[key]);
			}
		}
		
		create_barchart(selected_data, chart_sz, "#svg_barchart", margin, graph_properties, concordance_integration);
	}
	
	function order_changed()
	{
		var asc_order = false;
		if (document.getElementById('asc_order').checked)
		{
			asc_order = true;
		}
		
		graph_properties.order = (asc_order)?"ASC":"DSC";
		create_barchart(selected_data, chart_sz, "#svg_barchart", margin, graph_properties, concordance_integration);
	}
	
	function barcount_changed()
	{
		var barcount_number = parseInt(document.getElementById('bar_count').value);
		graph_properties.show = barcount_number;
		
		create_barchart(selected_data, chart_sz, "#svg_barchart", margin, graph_properties, concordance_integration);
	}
	
	var raw_data = [
		{ "sentence": "w1 test test test test", "sentiment": 0},
		{ "sentence": "w1 test test test test", "sentiment": 1},
		{ "sentence": "w2 test test test test", "sentiment": 1},
		{ "sentence": "w2 test test test test", "sentiment": 1},
		{ "sentence": "w3 test test test test", "sentiment": 0},
		{ "sentence": "w6 test test test test", "sentiment": 0},
		{ "sentence": "w6 test test test test", "sentiment": 1},
	];

	var word_table = [];
	for (var i = 0; i < raw_data.length; i ++) {

		var tokens = raw_data[i].sentence.replace("/\W/g", "").split(" ");

		for (var j = 0; j < tokens.length; j ++) {

			if (word_table[tokens[j]] == null) {
				word_table[tokens[j]] = {};
			}

			if (raw_data[i].sentiment) {
				if (word_table[tokens[j]].positive) word_table[tokens[j]].positive ++;
				else word_table[tokens[j]].positive = 1;
			}
			else {
				if (word_table[tokens[j]].negative) word_table[tokens[j]].negative ++;
				else word_table[tokens[j]].negative = 1;
			}
		}
	}

	var count = 0;
	var barchart_data = [];
	for (var w in word_table) {
		barchart_data[count] = {};
		barchart_data[count].word = w;
		barchart_data[count].positive = (word_table[w].positive) ? word_table[w].positive : 0;
		barchart_data[count].negative = (word_table[w].negative) ? word_table[w].negative : 0;
		count ++;
	}

	document.getElementById("bar_count").onkeyup = function() {
		var spinner = document.getElementById("bar_count");
		if (spinner.value < spinner.min) {
			spinner.value = spinner.min;
		}
		else if (spinner.value > spinner.max) {
			spinner.value = spinner.max;
		}
	}

	function concordance_integration(d) {
		concordance(
			d, // word.
			raw_data, // data.
			function(d) { // data.sentence.
				return d.sentence;
			},
			function(d) { // data.sentiment.
				if (d.sentiment) {
					return "#11AA00";
				}
				else {
					return "#C70039";
				}
			},
			15 // page size.
		);
	}

	// clone data currently selected
	var selected_data = new Array();
	// clone 
	Object.keys(barchart_data).forEach(function(key)
	{
    	selected_data.push(barchart_data[key]);
	});
	
	var colors = ["#11AA00", "#C70039"];
	var chart_sz = {height: 500, width:1000};
	var margin = {top:20, bottom:20, left:20, right:200};
	var graph_properties = {colors:["#11AA00", "#C70039"], show:20, order:"DSC", query:""}

	document.getElementById("bar_count").min = 1;
	document.getElementById("bar_count").max = barchart_data.length - 1;
	document.getElementById("bar_count").value = (barchart_data.length - 1 > 20) ? 20 : barchart_data.length - 1;
	
	// ASC for ascending
	// DSC for descending
	create_barchart(selected_data, chart_sz, "#svg_barchart", margin, graph_properties, concordance_integration);
	</script>
	
</body>
</html>